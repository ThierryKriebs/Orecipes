name: CICD with GitHub Actions and Surge

on:
  # On a push event on the branch: "cicd_surge"
  push:
    branches: ["cicd_surge"]

  # Creation of an optional manual trigger butto
  workflow_dispatch:

# Setting the permissions required for CI
permissions:
  # Permission to read the contents of the repository
  contents: read
 
  # Generate an authentication token
  id-token: write
 
# List of tasks to be completed
jobs:
  # Task build operation
  build:
    # Launch a runner under Ubuntu
    runs-on: ubuntu-latest
    env:
      # Specifies the necessary environnement variables `Settings > Secrets and variables`
      VITE_API_BASE_URL: ${{vars.VITE_API_BASE_URL}}
    
    # Task steps
    steps:
      # Copy the repository code into the Ubuntu runner
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4

      # Installation of PNPM without our dependencies
      - name: â¤ï¸ Installation of PNPM
        uses: pnpm/action-setup@v4
        with:
          version: 10
          run_install: false

      # Installing and configuring the Node environment
      - name: âš™ï¸ Setup de l'environnement Node.js
        uses: actions/setup-node@v4
        # with:
          # node-version: 22

      # Installation of our dependencies
      - name: ğŸ“¦ Installation of our dependencies
        run: pnpm install

      # Biome installation (with official action)
      - name: ğŸš€ Installation of Biome
        uses: biomejs/setup-biome@v2
        with:
          version: latest
      
      # Code verification with Biome
      - name: ğŸ¨ Run Biome to format and analyse the code
        run: biome ci .
        # run: biome check --apply # request to correct errors rather than block the CI

      # Launch of our tests
      - name: ğŸ§ª Launch of our tests
        run: pnpm test || echo "âš ï¸ No test found, but deployment continues..."

      # Build of our project
      - name: ğŸ—ï¸ Build of our project
        run: pnpm build

      # Upload the dist folder as an artifact
      - name: ğŸ“¤ Upload the dist folder as an artifact
        uses: actions/upload-artifact@v4
        with:
          path: dist
          name: dist 
  
  deploy:
    needs: build
    runs-on: ubuntu-latest
  
    steps:
      # Installation of PNPM without our dependencies
      - name: â¤ï¸ Installation of PNPM
        uses: pnpm/action-setup@v4
        with:
          version: 10
          run_install: false
    
      # Installation de Surge
      - name: Install Surge
        run: pnpm install --global surge
      
      # Download artifact "dist" generated with job "build"
      - name: ğŸ“¥ Download artifact "dist"
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist

      # Deploiement
      # (https://thecodersblog.com/deploying-static-website-surge-github-actions)
      # (https://dev.to/usamasubhani/deploy-react-apps-on-surge-using-github-actions-free-2h7i)
      # (https://github.com/yavisht/deploy-via-surge.sh-github-action-template)
      - name: Deploiement
        run: surge ./dist ${{ vars.SURGE_DOMAIN }}/
         --token ${{ secrets.SURGE_TOKEN }}

      # # Deploy the artefact
      # - name: Deploiement on GitHub Pages
      #   id: deployment
      #   uses: actions/deploy-pages@v4.0.5

      # #Display URL
      # - name: ğŸ”— URL
      #   run: echo ğŸ”— URL ${{ steps.deployment.outputs.page_url }}